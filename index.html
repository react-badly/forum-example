<!DOCTYPE html>
<html>
  <head>
    <script src="js/build/react-with-addons.js"></script>
    <script src="js/build/JSXTransformer.js"></script>
    <style>
      .VoteLine {
        padding: 0.5em 0.0em;
      }
      .VoteLine a {
        text-decoration: none;
        font-weight: bold;
      }
      .vote {
        font-weight:bold;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="example"></div>
    <div id="content"></div>
    <script type="text/jsx">
      React.render(
        <h1>Vote for your favorite Adventure Time character!</h1>,
        document.getElementById('example')
      );

      var Vote = React.createClass({
        handleUpVote: function(id, event) {
          for (var i = 0; i < this.state.votes.length; i++) {
            if (this.state.votes[i].id === id) {
              var t = [];
              t[i] = {
                count: { $set: this.state.votes[i].count + 1 }
              }
              var pp = React.addons.update(this.state.votes, t);
              this.setState({
                votes: pp,
                numVotes: this.state.numVotes + 1
              })
            }
          }
        },
        shouldComponentUpdate: function(nextProps, nextState) {
          for (var i = 0; i < this.state.votes.length; i++) {
            if (this.state.votes[i].count !== nextState.votes[i].count) {
              return true;
            }
          }
          return false;
        },
        getInitialState: function() {
          return {
            votes: this.props.votes,
            numVotes: this.props.votes.reduce(function(p, c) { return p + c.count; }, 0)
          }
        },
        render: function() {
          return (
            <div className="Vote">
              Welcome to Le Poll. {this.state.numVotes} votes
              <VoteList votes={this.state.votes} onUpVote={this.handleUpVote} />
            </div>
          )
        }
      });

      var VoteList = React.createClass({
        getInitialState: function() {
          return {
            votes: this.props.votes.sort(function(a, b) {
              return b.count - a.count;
            })
          }
        },
        incrementVote: function(voteId, vote) {
          var votes = this.state.votes;
          for (var i = 0; i < votes.length; i++) {
            if (votes[i].id === voteId) {
              votes[i] = vote;
            }
          }
          var n = votes.sort(function(a, b) {
            return b.count - a.count;
          });
          this.setState({ votes: n });
          this.props.onUpVote.bind(null, voteId);
        },
        render: function() {
          var self = this;
          var nodes = this.state.votes.map(function(vote) {
            return <VotePost key={vote.id} locked={vote.active} vote={vote} onUpVote={self.incrementVote} />
          });
          return (
            <div className="VoteList">{nodes}</div>
          )
        }
      });

      var VotePost = React.createClass({
        getInitialState: function() {
          return { locked: this.props.active, numVotes: this.props.vote.count, vote: this.props.vote }
        },
        incrementVote: function(count) {
          var vote = React.addons.update(this.state.vote, { count: { $set: this.state.vote.count + 1 } })
          this.setState({ vote: vote });
          this.props.onUpVote(vote.id, vote);
        },

        render: function() {
          var vote = this.props.vote;
          return (
            <div className="VoteLine" key={vote.id}>
              <a href="/votes/{vote.id}">{vote.title} ({this.state.vote.count})</a>&nbsp;
              <UpVote key={vote.id} count={vote.count} onUpVote={this.incrementVote} />
            </div>
          );
        }
      })

      var UpVote = React.createClass({
        render: function() {
          return (
            <span onClick={this.props.onUpVote} className="vote">&#x21ea;</span>
          )
        }
      })
      var VOTE_ITEMS = [
        { "id": 3, "title": "Finn the Human", "count": 40 },
        { "id": 2, "title": "Jake The Dog", "count": 22 },
        { "id": 1, "title": "Princess Bubblegum", "count": 102 },
        { "id": 4, "title": "The Ice King", "count": 13 },
        { "id": 5, "title": "BMO", "count": 128 },
      ]

      React.render(
        <Vote votes={VOTE_ITEMS} />,
        document.getElementById('content')
      );
    </script>
  </body>
</html>
